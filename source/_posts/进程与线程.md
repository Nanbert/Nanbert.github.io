---
title: 进程与线程
date: 2023-09-03 15:21:11
tags:
banner_img: /images/processThread.png
index_img:: /images/processThread.png
---
# 7进程环境
## main函数的启动
当内核执行c程序时，在调用main前先调用一个特殊的启动例程。可执行程序文件将此启动例程指定为程序的起始地址（连接器指定）,启动例程从内核取得命令行参数和环境变量值，然后调用main函数
## 进程终止
### 8种终止方式
1. 从main返回
2. 调用exit
3. 调用_exit或_Exit
4. 最后一个线程从其启动例程返回
5. 最后一个线程调用pthread_exit
异常终止:
6. 调用abort
7. 接到一个信号
8. 最后一个线程对取消请求做出响应
### atexit函数
```C
#include <stdlib.h>
int atexit(void (*func)(void));
// 登记成功返回0
```
终止处理函数，一个进程可以登记最多32个函数
![](/images/exit.png)
## 内存空间分布
![](/images/memory_struct.png)
磁盘上的可执行文件并不存放bss内容，内核在程序开始运行前将它们都设为0。磁盘可执行文件只存取text和初始化段
`size /path/bin`可查看某执行文件的各个段的长度
## 共享库
gcc默认使用共享库，可使用-static阻止使用共享库
## 内存分配函数
- malloc: 分配指定字节数的存储区。初始值不确定
- calloc: 为指定数量指定长度的对象分配存储空间,初始化为0
- realloc: 增加或减少以前分配区的长度。增加时新增区的初始值不确定
它们都是调用sbrk的系统调用，sbrk可扩充或缩小进程的存储空间，但是大多数的malloc和free的实现都不减小进程的存储空间。释放的空间可供以后再分配
这三个函数都有debug版本，进行附加检错，通过设置环境变量支持
**alloca**函数分配的空间在栈上
## 环境变量
全局变量environ(char**)，指向环境表，一般不对它进行直接操作
![](/images/environ.png)
- `char* getenv(const char* name)`
- `int putenv(char *str)`str是类似`name = value`, 会直接将该值的地址放到环境表中,所以str不能是栈上的
- `int setenv(const char *name, const char* value, int rewrite)` rewrite为0,则不删除现有定义
- `int unsetenv(const char* name)`
环境表和环境字符串通常位于进程空间的顶部，所以如果增加环境变量或值字符串变长，系统会调用malloc在堆上分配空间
## setjmp和longjmp函数间的跳转
```C
#include <setjmp.h>
int setjmp(jmp_buf env)//若直接调用，返回0；若从longjmp返回，则非0
void longjmp(jmp_Buf env, int val)
```
在函数之间的跳转，会舍弃中间的帧，无法确保变量的值，在同一个系统中，要想获得可靠的值，则要加上volatile关键字，这并不能保证(p218仔细看把)
## getrlimit和setrlimit资源限制函数
(todo,目前感觉用处不大)
# 进程控制
## 进程标识
- 进程0：调度进程，也叫交换进程，内核的一部分，不执行任何磁盘上的程序
- 进程1：init进程，自举过程结束，由内核调用，永不会终止，以超级用户特权运行的普通用户进程
## fork
fork完文件表项如下图
![](/images/fd.png)
## 僵尸进程和孤儿进程
- 僵尸进程：子进程终止，父进程未wait回收其资源
- 孤儿进程：子进程未结束，父进程终止了，此时，成为孤儿进程，之后由内核的进程1托管成为父进程
## exec
用磁盘上的一个新程序替换当前进程的正文段、数据段、堆和栈
## wait函数
wait函数会回收子进程的结束状态，但有些wait函数是只读，这可以再次wait，读取其状态
## setuid
set-user-id就是ls -l权限中的s权限
![](/images/uid.png)
## system
该函数其实调用了fork->exec->waitpid函数，有设置用户id的程序最后不用该函数，可能使得system执行的程序权限提升，正确做法fork前设置适当的有效用户id
## 设置priority函数
nice、getpriority、setpriority
## 进程会计--pacct命令
## 进程时间--times

