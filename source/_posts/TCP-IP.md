---
title: TCP/IP
date: 2022-10-03 10:52:48
subtitle:
categories:
tags:
banner_img: /images/TCP_IP.png
index_img: /images/TCP_IP.png
---

# UDP存在的意义
![](/images/UDP.png)
- 无需建立连接，不会引入建立连接的时延
- 无连接状态，tcp需要维护接发缓存、拥塞控制参数、序号及确认号的参数
- 分组首部更小
- 无拥塞控制，对于不希望过分延迟报文段的传送并且容忍数据丢失的场景适用
# 校验和的计算
- 发送方对UDP报文段中的所有16比特字进行累加，溢出将回卷，并取反得到校验和。
- 接收方将所有16比特字(包括校验和)进行累加,无错即得到全1
# TCP
![](/images/TCP.png)
## 涉及概念
- ACK:肯定确认,在TCP头部中表示当前对确认字段中的值是有效的,明显第一次握手时，该值置为0
- NAK:否定确儿（TCP中没有，只需确认最后一次接收到的分组即可）
- GBN:回退N步
- SR:选择重传
- MSS:最大报文长度,不包括头40字节
- MTU:最大传输单元，链路层的最大帧长度(以太网中为1500字节)，MSS=MTU-40(TCP+IP首部长度)
- RTT:往返时间
## 六比特标识位
- URG:用于指示报文段里存在着被发送端的上层实体置为紧急的数据(一般不用)
- ACK:用于指示确认字段的值是有效的
- PSH:用于指示接收方应立即将数据交给上层(一般不用)
- RST:用于告诉源：我没有那个报文段的套接字(即端口号未开)，不要再发送该报文,udp遇到这种情况会发送一个ICMP的数据报
- SYN:用于建立连接
- FIN:用于拆除连接
## 流量控制
- rwnd(接受窗口)=RcvBuffer-[LastByteRcvd-LastByteRead]
## 三次握手
![](/images/handshake.png)
- 第一次：SYN为1,ACK为0,随机初始化一个seq(client_isn)
- 第二次：SYN为1,ACK为1,随机初始化一个seq(server_isn),并设置确认号ack(client_isn+1)，此时服务器可能分配缓存和变量（此时分配会受到SYN洪泛攻击）
- 第三次：SYN为1,ACK为1,客户分配缓存和变量，并可以携带有效数据
## 四次挥手
![](/images/byebye.png)
- 第一次(假设客户端先手)：FIN为1，ACK=0,随机一个seq,此时不发送有效数据，仍然可以接受数据
- 第二次：ACK=1,ackNum为seq+1,此时服务器仍然可以发送数据
- 第三次：FIN为1，ACK=0,随机一个seq，此时服务器不发送有效数据
- 第四次：ACK=1,ackNum为seq+1
## 拥塞控制
- 发送方跟踪额外的变量:拥塞窗口(cwnd),注意这与流量控制不同，**不体现在tcp头部中**
- LastByteSent-LastByteAcked<=min{cwnd,rwnd}
- 初始化时，cwnd通常为1个MSS，然后进入慢启动(指数增长),遇到拥塞，cwnd减半，并设置ssthresh=cwnd/2(慢启动阈值),结束慢启动
- TCP的拥塞控制：每个RTT内cwnd线性增加1个MSS，出现3个冗余ACK时，cwnd减半（加性增、乘性减）
# IP
## ipv4
![](/images/IP.png)
### 关键字段
- 版本号：4比特，定义是ipv4还是ipv6
- 首部长度：4比特，定义首部长度
- 服务类型：8比特，服务类型(延时低，高吞吐等)
- 数据包长度：ip数据报总长度（首部+数据）
- 标识、标志、偏移：ip分片有关
- 寿命：8字节，没经过一个路由减1,为0时丢弃
- 协议：表示上层协议（UDP还是）
- 首部校验和：只针对头部计算，注意由于寿命会变，所以需要不断的更新
- 源和目的ip地址：没啥好说
- 选项：很少使用，ipv6中就没有
- 有效数据
### 数据报分片
![](/images/IP_fra.png)
- 之前提到过，一个链路层帧能承载的最大数据量叫做**最大传送单元（MTU）**
- 广域网和局域网可能MTU不同所以要分片
- 分片的重组放在端系统中，路由器不负责重组
- 最后一片标志被置为0
### ipv4编址
- 接口：主机与物理链路之间的边界叫做接口
- ip地址：IP协议要求每台主机和路由器的接口拥有自己的IP地址
**从技术上来讲一个ip地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联**
- 子网掩码：a.b.c.d/x,x最高比特构成了IP地址的网络部分，为网络前缀
- CIDR：无类别域间路由选择，这种更灵活
- 分类编址（不灵活）：A类子网(8bit)，B类子网(16bit)，C类子网(24bit),会有c类太少，b类太大的烦恼
### DHCP动态主机配置协议
性质：基于UDP的应用层协议,默认端口67
作用： 除了分配IP地址外，DHCP还允许获取其他信息子网掩码，默认网关（第一跳路由器），本地DNS服务器地址
![](/images/DHCP.png)
### 网络地址转换-NAT
- 会改写IP地址和端口号
![](/images/NAT.png)
## ipv6
![](/images/IPV6.png)
- 版本：显然设为6
- 流量类型：与ipv4服务类型类似
- 流标签：标识一条数据报的流，还未完全确定
- 有效载荷长度
- 跳限制：计数为0丢弃
### ipv4->ipv6:隧道
![](/images/tunneling.png)
## 通用转发和SDN
- OpenFLow标准
- SDN
- 就是根据各层的头信息执行特定转发，有更大灵活性，跳出IP转发的局限性

